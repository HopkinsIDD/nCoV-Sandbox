---
title: "Dispersion vs. Control"
output: html_document
author:
  - C. Jessica E. Metcalf
  - Kyra Grantz
  - Justin Lessler
---

```{r setup, include=FALSE}
  knitr::opts_chunk$set(echo = TRUE)

  country.dat <- read.csv("data/WHOSitrepTable2.csv")
  
  require(tidyverse)
  require(gridExtra)

```


Despite introductions of the novel coronavirus into 27 countries, as of February 8, 2020, there has been little documented onward transmission. At the start of the outbreak, the key epidemiological quantity, $R_0$ was estimated to be somewhere between 2 and 3, i.e., early growth features of the outbreak indicate that, on average, one infected individual infects between 2 and 3 other individuals. However, there has been very little onward transmission outside of China (and perhaps even in other provinces within China) despite numerous introductions. These apparently contradictory results can be reconciled in two ways: (A) onward transmission of the virus is much less likely outside of China, presumably due to case finding paired with isolation and quarantine, or (B) transmission of CoVID-19 is in general overdispersed, i.e., the majority of transmission is due to a few superspreading events, while the vast majority of infected individuals do not transmit the virus. Perhaps most likely is that we are seeing some combination of these two effects. 

By examining the number of introductions that have failed to result in onward transmission, we can get a sense of how extreme each of these effects has to be, and how they might work in combination, to produce the observed results.  Following [Lloyd-Smith et al. 2005](https://www.nature.com/articles/nature04153), we assume that the number of secondary cases associated with an infectious individual is drawn from a negative binomial probability distribution with population mean $R_0$, where this distribution encodes individual characteristics of contact, environment, etc., that might modulate individual onward transmission. 

#### Data

Using data from the [WHO Situation Report](https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports) on the number of assumed imported and local cases in countries to simulate an expected number of secondary infections caused by each known infection within country, assuming a uniform distribution of onward transmission events across all known cases. We repeat this simulation process 10,000 times to model the uncertainty in the data.

```{r}
nreps = 10000

## Generate datasets from known number of cases (total + assumed local transmission in each country)
sim_data <- function(nreps, ntotal.vec, nlocal.vec){
  tmp <- matrix(rep(0, nreps), nrow=1)
  for(i in 1:length(ntotal.vec)){
    tmp <- rbind(tmp, rmultinom(nreps, nlocal.vec[i], rep(1/ntotal.vec[i], ntotal.vec[i])))
  }
  return(tmp[-1,])
}
 
tmp.dat <- sim_data(nreps, country.dat$confirmed, country.dat$cases.outside)

```



#### Dispersion parameter estimation

We then find the optimal $\theta$ that best make each assumed imulated data set consistent with a random value of $R_0$ drawn from a plausible range. Individual variation in infectiousness implies outbreaks are rarer but more explosive. Interpreting the $\theta$ parameter is eased by framing it in terms of the fraction of individuals responsible for 80\% of onwards transmission (by analogy with the 20/80 rule). 

Key functions used in the anlaysis:

```{r, message=FALSE, warning=FALSE}

## Find the optimal theta for each value of R
## and stuff everything in a data frame
to_optim <- function(theta, R0, data) {
  -sum(dnbinom(x=data, size=theta,  mu=R0, log = TRUE))
}

do_optim <- function(R0, data) {
  return(optimize(to_optim,c(0,5000),R0=R0, data=data)$minimum)
}


##Get the proportion to infect some percentage of the population given
##a R0 and theta.
getPropInfected <- Vectorize(function(R0,theta,target.prop=0.80) {
    max.x <- 5000
    tmp <- dnbinom(1:max.x, mu=R0, size=theta) * 1:max.x
    tmp2 <- rev(cumsum(rev(tmp)))/sum(tmp)
    rc<-1-pnbinom(which.min(abs(tmp2-target.prop)), mu=R0, size=theta)
    return(rc)
  
})



```


```{r, ech0=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=5}

# fitting to simulated data

# theta MLE for each pair of simulated data + randomly drawn R0
Rvec <- runif(nreps, 0.1, 3)

tmp <- vector(length=nreps)
tmp_sars <- vector(length=nreps)
tmp_R2 <- vector(length=nreps)
for(i in 1:nreps){
  tmp[i] <- do_optim(Rvec[i], data = tmp.dat[,i]) #optimal theta for random R
}

dat <- data.frame(Rvec, 
                  theta = tmp, 
                  p80 = getPropInfected(Rvec, tmp))


##%>% filter(theta<10)
p1 <- ggplot(dat%>%mutate(theta=ifelse(theta>10,10, theta)) , aes(x=Rvec, y=theta)) +
        geom_point(col='navy', alpha=0.1) +
        geom_smooth(col='black') +
        scale_x_log10() +
        scale_y_log10() +
        theme_bw() + xlab("R0") +
        geom_hline(yintercept = .16, lty=2, color="red" ) +
        geom_rect(aes(xmin=2,xmax=3, ymin=min(theta), ymax=10),fill="black", alpha=.002) +
        xlab(expression(R[0])) +
        ylab(expression(theta))


p2 <- ggplot(dat, aes(x=Rvec, y=p80)) +
        geom_point(col='navy', alpha=0.1) +
        geom_smooth(col='black') +
        scale_x_log10() +
        scale_y_log10() + theme_bw() + xlab("R0")+
        geom_rect(aes(xmin=2,xmax=3, ymin=min(p80), ymax=.1),fill="black", alpha=.002) +
        ylab("Propotion infecting 80%") +
        xlab(expression(R[0]))

grid.arrange(p1, p2,
             ncol=1)
```

**Figure** (top) The optimal $\theta$ versus $R_0$ over 10,000 simulated data sets, (bottom) the 
proportion responsible for 80% of infections. Red dashed  horizontal line represents the dispersion
estimated for SARS in Singapore, and the shaded region represents a rough range of plausible
$R_0$s for the outbreak of CovID-19 in Wuhan.


We find a range of possible values of overdispersion consistent with the observed data at $R_0 = 2$, as well as reduced mean $R_0$ values. We estimate that, if $R_0$ outside of China were equal to 2, as estimated within Wuhan, just 6.5% of all infections would be responsible for 80% of onward transmission events. At modest
reductoins in $R_0$, we find that 

#### Conclusions
Here, we demonstrate that the relative lack of observed onward transmission following introductions of Covid-19 outside of China may be at least partially attributable to overdispersion in the population distribution of $R_0$. These results driven by the extreme skew of the near absence of secondary infections emerging from international infections. Intermediate numbers of onwards transmission may be unobserved (perhaps as a result of mild cases) or alternatively may simply not yet have occurred (as this is inherently a stochastic process). As further data emerges in the coming weeks, this could help identify which scenario is in play. 

However, this simple analysis may be useful in thinking about what scenarios are plausible as we try to understand the epidemiology of Covid-19, and reconcile apparent inconsistencies between how the virus is spreading in Wuhan and elsewhere in the world. 


